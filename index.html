<!-- Add this CSS in the head section -->
<style>
  .highlight {
    background-color: yellow;
    opacity: 0.7;
    border-radius: 2px;
  }
  .highlight.active {
    background-color: orange;
    opacity: 0.9;
  }
</style>

<!-- Replace the search script section with this improved version -->
<script>
  // Search functionality variables
  let searchMatches = [];
  let currentMatchIndex = -1;
  let searchQuery = '';
  let textLayer = null;

  document.getElementById('search-input').addEventListener('input', async function() {
    searchQuery = this.value.trim().toLowerCase();
    if (!pdfDoc || !searchQuery) {
      clearHighlights();
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('search-navigation').style.display = 'none';
      return;
    }

    document.getElementById('search-results').innerHTML = 'Searching...';
    searchMatches = [];
    currentMatchIndex = -1;

    const totalPages = pdfDoc.numPages;
    let processedPages = 0;

    for (let i = 1; i <= totalPages; i++) {
      const page = await pdfDoc.getPage(i);
      const textContent = await page.getTextContent();
      
      const textItems = textContent.items;
      let pageText = '';
      let pageMatches = [];

      textItems.forEach((item, itemIndex) => {
        const itemText = item.str.toLowerCase();
        if (itemText.includes(searchQuery)) {
          let index = item.str.toLowerCase().indexOf(searchQuery);
          while (index !== -1) {
            pageMatches.push({
              pageNum: i,
              itemIndex,
              startIndex: index,
              endIndex: index + searchQuery.length,
              text: item.str
            });
            index = item.str.toLowerCase().indexOf(searchQuery, index + 1);
          }
        }
        pageText += item.str + ' ';
      });

      if (pageMatches.length > 0) {
        searchMatches.push(...pageMatches);
      }

      processedPages++;
      if (processedPages === totalPages) {
        updateSearchResults();
      }
    }
  });

  function updateSearchResults() {
    const resultsContainer = document.getElementById('search-results');
    const searchNav = document.getElementById('search-navigation');
    
    if (searchMatches.length === 0) {
      resultsContainer.innerHTML = 'No matches found';
      searchNav.style.display = 'none';
      return;
    }

    // Group matches by page
    const matchesByPage = {};
    searchMatches.forEach(match => {
      if (!matchesByPage[match.pageNum]) {
        matchesByPage[match.pageNum] = [];
      }
      matchesByPage[match.pageNum].push(match);
    });

    // Display results
    let resultsHTML = `<div>Found ${searchMatches.length} match(es) on ${Object.keys(matchesByPage).length} page(s):</div>`;
    
    for (const pageNum in matchesByPage) {
      const pageMatches = matchesByPage[pageNum];
      resultsHTML += `<div class="search-result" data-page="${pageNum}">Page ${pageNum}: ${pageMatches.length} match(es)</div>`;
    }

    resultsContainer.innerHTML = resultsHTML;
    searchNav.style.display = 'flex';
    document.getElementById('match-count').textContent = `Match ${currentMatchIndex + 1} of ${searchMatches.length}`;

    // Add click handlers to page results
    document.querySelectorAll('.search-result').forEach(el => {
      el.addEventListener('click', () => {
        const pageNum = parseInt(el.getAttribute('data-page'));
        const firstMatchOnPage = searchMatches.find(m => m.pageNum === pageNum);
        if (firstMatchOnPage) {
          currentMatchIndex = searchMatches.indexOf(firstMatchOnPage);
          goToMatch(currentMatchIndex);
        }
      });
    });

    // Go to first match if any
    if (searchMatches.length > 0) {
      currentMatchIndex = 0;
      goToMatch(currentMatchIndex);
    }
  }

  async function goToMatch(index) {
    if (index < 0 || index >= searchMatches.length) return;
    
    const match = searchMatches[index];
    currentMatchIndex = index;
    
    // Update UI
    document.getElementById('match-count').textContent = `Match ${index + 1} of ${searchMatches.length}`;
    
    // Go to page and highlight
    if (pageNum !== match.pageNum) {
      pageNum = match.pageNum;
      await renderPage(pageNum);
    }
    highlightMatch(match);
  }

  function highlightMatch(match) {
    clearHighlights();
    
    // Create a persistent text layer if it doesn't exist
    if (!textLayer) {
      textLayer = document.createElement('div');
      textLayer.className = 'textLayer';
      textLayer.style.position = 'absolute';
      textLayer.style.left = canvas.offsetLeft + 'px';
      textLayer.style.top = canvas.offsetTop + 'px';
      textLayer.style.width = canvas.width + 'px';
      textLayer.style.height = canvas.height + 'px';
      textLayer.style.pointerEvents = 'none'; // Allow clicks to pass through
      document.body.appendChild(textLayer);
    }
    
    pdfDoc.getPage(match.pageNum).then(page => {
      const viewport = page.getViewport({ scale: scale });
      
      page.getTextContent().then(textContent => {
        // Clear previous content
        textLayer.innerHTML = '';
        
        // Create text div for the matched item
        const textDiv = document.createElement('div');
        textDiv.style.position = 'absolute';
        textDiv.style.left = '0';
        textDiv.style.top = '0';
        textDiv.style.lineHeight = '1';
        textDiv.dataset.itemIndex = match.itemIndex;
        
        // Add the text content
        const textNode = document.createTextNode(textContent.items[match.itemIndex].str);
        textDiv.appendChild(textNode);
        textLayer.appendChild(textDiv);
        
        // Position the text element
        pdfjsLib.TextLayer.renderTextLayer({
          textContent: {
            items: [textContent.items[match.itemIndex]]
          },
          container: textLayer,
          viewport: viewport,
          textDivs: [textDiv]
        });
        
        // Highlight the matched portion
        const range = document.createRange();
        range.setStart(textNode, match.startIndex);
        range.setEnd(textNode, match.endIndex);
        
        const highlightSpan = document.createElement('span');
        highlightSpan.className = 'highlight active';
        range.surroundContents(highlightSpan);
        
        // Scroll to the highlight
        highlightSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    });
  }

  function clearHighlights() {
    if (textLayer) {
      textLayer.querySelectorAll('.highlight').forEach(el => {
        el.classList.remove('active');
      });
    }
  }

  // Navigation between matches
  document.getElementById('prev-match').addEventListener('click', () => {
    if (currentMatchIndex > 0) {
      currentMatchIndex--;
      goToMatch(currentMatchIndex);
    }
  });

  document.getElementById('next-match').addEventListener('click', () => {
    if (currentMatchIndex < searchMatches.length - 1) {
      currentMatchIndex++;
      goToMatch(currentMatchIndex);
    }
  });
</script>
